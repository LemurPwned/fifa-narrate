<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html;charset=utf-8">
  <title>text_detection.py</title>
  <link rel="stylesheet" href="pycco.css">
</head>
<body>
<div id='container'>
  <div id="background"></div>
  <div class='section'>
    <div class='docs'><h1>text_detection.py</h1></div>
  </div>
  <div class='clearall'>
  <div class='section' id='section-0'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-0'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pytesseract</span>
<span class="kn">import</span> <span class="nn">cv2</span>
<span class="kn">import</span> <span class="nn">imutils</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">asyncio</span>
<span class="kn">from</span> <span class="nn">copy</span> <span class="kn">import</span> <span class="n">deepcopy</span>
<span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">from</span> <span class="nn">queue</span> <span class="kn">import</span> <span class="n">Queue</span>
<span class="kn">from</span> <span class="nn">boundary_detection</span> <span class="kn">import</span> <span class="n">findScores</span><span class="p">,</span> <span class="n">findSurnames</span><span class="p">,</span> <span class="n">findTime</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="n">rois</span> <span class="o">=</span> <span class="p">{</span>  <span class="c1"># for 1000 width</span>
    <span class="s1">&#39;time&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">108</span><span class="p">,</span> <span class="mi">69</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">23</span><span class="p">),</span>
    <span class="s1">&#39;team1&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">53</span><span class="p">,</span> <span class="mi">52</span><span class="p">,</span> <span class="mi">53</span><span class="p">,</span> <span class="mi">21</span><span class="p">),</span>
    <span class="s1">&#39;team2&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">161</span><span class="p">,</span> <span class="mi">52</span><span class="p">,</span> <span class="mi">52</span><span class="p">,</span> <span class="mi">16</span><span class="p">),</span>
    <span class="s1">&#39;score&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">110</span><span class="p">,</span> <span class="mi">53</span><span class="p">,</span> <span class="mi">48</span><span class="p">,</span> <span class="mi">20</span><span class="p">),</span>
    <span class="s1">&#39;player1&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">80</span><span class="p">,</span> <span class="mi">502</span><span class="p">,</span> <span class="mi">129</span><span class="p">,</span> <span class="mi">33</span><span class="p">),</span>
    <span class="s1">&#39;player2&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">788</span><span class="p">,</span> <span class="mi">506</span><span class="p">,</span> <span class="mi">133</span><span class="p">,</span> <span class="mi">28</span><span class="p">)</span>
<span class="p">}</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-1'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-1'>#</a>
      </div>
      <p>config may be shadowed in training</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="n">config</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;-l eng --oem 2 --psm 7 --tessdata-dir ./tessdata &#39;</span><span class="p">)</span>

<span class="n">win_name</span> <span class="o">=</span> <span class="s1">&#39;Match Detection&#39;</span>

<span class="n">test_vide_file</span> <span class="o">=</span> <span class="s1">&#39;FIFA 19  Chelsea vs Tottenham Hotspur  Premier League Gameplay.mp4&#39;</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-2'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-2'>#</a>
      </div>
      <p>Tries to find relevant rois for text extraction</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">detect_true_rois</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">detected_rois</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-3'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-3'>#</a>
      </div>
      <h2>Parameters</h2>
<p>image: np.array
    image to be analysed</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">if</span> <span class="ow">not</span> <span class="n">detected_rois</span><span class="p">:</span>
        <span class="n">scores_xpos</span><span class="p">,</span> <span class="n">scores_ypos</span> <span class="o">=</span> <span class="n">findScores</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
        <span class="n">surnames_xposL</span><span class="p">,</span> <span class="n">surnames_yposL</span><span class="p">,</span> <span class="n">surnames_xposR</span><span class="p">,</span> <span class="n">surnames_yposR</span> <span class="o">=</span> <span class="n">findSurnames</span><span class="p">(</span>
            <span class="n">image</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-4'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-4'>#</a>
      </div>
      <p>time_xpos, time_ypos = None, None</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">offset_x</span> <span class="o">=</span> <span class="mi">50</span>
        <span class="n">time_xpos</span><span class="p">,</span> <span class="n">time_ypos</span> <span class="o">=</span> <span class="n">findTime</span><span class="p">(</span>
            <span class="n">image</span><span class="p">,</span>
            <span class="n">scores_xpos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">offset_x</span><span class="p">,</span> <span class="n">scores_ypos</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
            <span class="n">scores_xpos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="n">offset_x</span><span class="p">,</span> <span class="n">scores_ypos</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">30</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">a</span> <span class="ow">is</span> <span class="bp">None</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="p">[</span>
            <span class="n">scores_xpos</span><span class="p">,</span> <span class="n">scores_ypos</span><span class="p">,</span>
            <span class="n">surnames_xposL</span><span class="p">,</span> <span class="n">surnames_yposL</span><span class="p">,</span>
            <span class="n">surnames_xposR</span><span class="p">,</span> <span class="n">surnames_yposR</span><span class="p">,</span>
            <span class="n">time_xpos</span><span class="p">,</span> <span class="n">time_ypos</span>
        <span class="p">]):</span>
            <span class="k">print</span><span class="p">([</span>
                <span class="n">scores_xpos</span><span class="p">,</span> <span class="n">scores_ypos</span><span class="p">,</span>
                <span class="n">surnames_xposL</span><span class="p">,</span> <span class="n">surnames_yposL</span><span class="p">,</span>
                <span class="n">surnames_xposR</span><span class="p">,</span> <span class="n">surnames_yposR</span><span class="p">,</span>
                <span class="n">time_xpos</span><span class="p">,</span> <span class="n">time_ypos</span>
            <span class="p">])</span>
            <span class="n">detected_rois</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="n">true_rois</span> <span class="o">=</span> <span class="p">[[</span><span class="n">scores_xpos</span><span class="p">,</span> <span class="n">scores_ypos</span><span class="p">],</span>
                         <span class="p">[</span><span class="n">surnames_xposL</span><span class="p">,</span> <span class="n">surnames_yposL</span><span class="p">],</span>
                         <span class="p">[</span><span class="n">surnames_xposR</span><span class="p">,</span> <span class="n">surnames_yposR</span><span class="p">],</span>
                         <span class="p">[</span><span class="n">time_xpos</span><span class="p">,</span> <span class="n">time_ypos</span><span class="p">]]</span>

    <span class="k">if</span> <span class="n">true_rois</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">roi</span> <span class="ow">in</span> <span class="n">true_rois</span><span class="p">:</span>
            <span class="n">cv2</span><span class="o">.</span><span class="n">rectangle</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="p">(</span><span class="n">roi</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">roi</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]),</span> <span class="p">(</span>
                <span class="n">roi</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">roi</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]),</span> <span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="mi">3</span><span class="p">)</span>
        <span class="n">offset_x</span> <span class="o">=</span> <span class="mi">50</span>
        <span class="n">cv2</span><span class="o">.</span><span class="n">rectangle</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="p">(</span><span class="n">scores_xpos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">offset_x</span><span class="p">,</span> <span class="n">scores_ypos</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="p">(</span>
            <span class="n">scores_xpos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="n">offset_x</span><span class="p">,</span> <span class="n">scores_ypos</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">30</span><span class="p">),</span> <span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="mi">3</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-5'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-5'>#</a>
      </div>
      <p>Display information from any dict passed</p>
<h2>Parameters</h2>
<p>image: np.array (2D)
    image to be overlayed
custom_dict: dict 
    dictionary with values</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">display_info_dict</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">custom_dict</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-6'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-6'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">if</span> <span class="n">custom_dict</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">custom_dict</span><span class="p">):</span>
            <span class="n">text</span> <span class="o">=</span> <span class="n">f</span><span class="s2">&quot;{key}: {custom_dict[key]}&quot;</span>
            <span class="n">cv2</span><span class="o">.</span><span class="n">putText</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">ih</span> <span class="o">-</span> <span class="p">((</span><span class="n">i</span> <span class="o">*</span> <span class="mi">20</span><span class="p">)</span> <span class="o">+</span> <span class="mi">20</span><span class="p">)),</span>
                        <span class="n">cv2</span><span class="o">.</span><span class="n">FONT_HERSHEY_SIMPLEX</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-7'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-7'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">waitForRoi</span><span class="p">():</span>
    <span class="k">if</span> <span class="n">cv2</span><span class="o">.</span><span class="n">waitKey</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span> <span class="o">==</span> <span class="nb">ord</span><span class="p">(</span><span class="s1">&#39;s&#39;</span><span class="p">):</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">selectROI</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
        <span class="n">cv2</span><span class="o">.</span><span class="n">destroyAllWindows</span><span class="p">()</span>
        <span class="n">textImage</span> <span class="o">=</span> <span class="n">image</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span><span class="nb">int</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">r</span><span class="p">[</span><span class="mi">3</span><span class="p">]),</span> <span class="nb">int</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span><span class="nb">int</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">r</span><span class="p">[</span><span class="mi">2</span><span class="p">])]</span>
        <span class="n">text</span> <span class="o">=</span> <span class="n">pytesseract</span><span class="o">.</span><span class="n">image_to_string</span><span class="p">(</span><span class="n">textImage</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">)</span>
        <span class="n">cv2</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">win_name</span><span class="p">,</span> <span class="n">textImage</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cv2</span><span class="o">.</span><span class="n">waitKey</span><span class="p">(</span><span class="mi">5000</span><span class="p">):</span>
            <span class="n">cv2</span><span class="o">.</span><span class="n">destroyAllWindows</span><span class="p">()</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-8'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-8'>#</a>
      </div>
      <p>Determine if the new values in the dictionary are valid
If not, let the pervious values to persist</p>
<h2>Parameters</h2>
<p>persistence_dict dict 
    persistive dictionary
detection_dict dict 
    new dictionary to be validated</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">validate_dict</span><span class="p">(</span><span class="n">persistence_dict</span><span class="p">,</span> <span class="n">detection_dict</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-9'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-9'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">regex</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;time&#39;</span><span class="p">:</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s1">&#39;[0-9]{1,2}:[0-9]{2}&#39;</span><span class="p">),</span>
        <span class="s1">&#39;score&#39;</span><span class="p">:</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s1">&#39;[0-9]-[0-9]&#39;</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">detection_dict</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">regex</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">regex</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">detection_dict</span><span class="p">[</span><span class="n">key</span><span class="p">])</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;unmatched {key} with {detection_dict[key]}&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">persistence_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">detection_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">persistence_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">detection_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-10'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-10'>#</a>
      </div>
      <p>Recognize text in the given ROI</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">roi_text_recognition</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="n">img_copy</span><span class="p">,</span> <span class="n">cpy_persistence</span><span class="p">,</span> <span class="n">rois</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-11'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-11'>#</a>
      </div>
      <pre><code>Parameters 
------
queue: Queue 
    queue for multithreading
img_copy: np.array 
    image to be analysed
cpy_persistence: dict 
    persistence dictionary to be updated 
                            with text values
rois: dict 
    dictionary with values of rois to extract from image
</code></pre>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">detected</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">config</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;-l eng --oem 2 --psm 7 --tessdata-dir ./tessdata &#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">textObj</span> <span class="ow">in</span> <span class="n">rois</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">rois</span><span class="p">[</span><span class="n">textObj</span><span class="p">]</span>
        <span class="n">textImage</span> <span class="o">=</span> <span class="n">img_copy</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span><span class="nb">int</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">r</span><span class="p">[</span><span class="mi">3</span><span class="p">]),</span>
                             <span class="nb">int</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span><span class="nb">int</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">r</span><span class="p">[</span><span class="mi">2</span><span class="p">])]</span>
        <span class="n">text</span> <span class="o">=</span> <span class="n">pytesseract</span><span class="o">.</span><span class="n">image_to_string</span><span class="p">(</span><span class="n">textImage</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">)</span>
        <span class="n">detected</span><span class="p">[</span><span class="n">textObj</span><span class="p">]</span> <span class="o">=</span> <span class="n">text</span>
    <span class="n">validate_dict</span><span class="p">(</span><span class="n">cpy_persistence</span><span class="p">,</span> <span class="n">detected</span><span class="p">)</span>
    <span class="n">queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">cpy_persistence</span><span class="p">)</span>


<span class="n">cap</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">VideoCapture</span><span class="p">(</span><span class="n">test_vide_file</span><span class="p">)</span>
<span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">detection_thread</span> <span class="o">=</span> <span class="bp">None</span>

<span class="n">queue</span> <span class="o">=</span> <span class="n">Queue</span><span class="p">()</span>
<span class="n">persistence_dict</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">detected_rois</span> <span class="o">=</span> <span class="bp">False</span>
<span class="n">true_rois</span> <span class="o">=</span> <span class="bp">None</span>
<span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
    <span class="n">idx</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">rate</span><span class="p">,</span> <span class="n">image</span> <span class="o">=</span> <span class="n">cap</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="mi">500</span><span class="p">:</span>
        <span class="k">continue</span>
    <span class="n">image</span> <span class="o">=</span> <span class="n">imutils</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
    <span class="p">(</span><span class="n">ih</span><span class="p">,</span> <span class="n">iw</span><span class="p">)</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">center</span> <span class="o">=</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">iw</span><span class="o">/</span><span class="mi">2</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">ih</span><span class="o">/</span><span class="mi">2</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">idx</span> <span class="o">%</span> <span class="mi">50</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">queue</span><span class="o">.</span><span class="n">empty</span><span class="p">():</span>
            <span class="n">rcv_dict</span> <span class="o">=</span> <span class="n">queue</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">rcv_dict</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">persistence_dict</span> <span class="o">=</span> <span class="n">rcv_dict</span>
        <span class="k">if</span> <span class="n">detection_thread</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">detection_thread</span><span class="o">.</span><span class="n">isAlive</span><span class="p">():</span>
            <span class="n">gray</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">COLOR_BGR2GRAY</span><span class="p">)</span>
            <span class="n">gray</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">bitwise_not</span><span class="p">(</span><span class="n">gray</span><span class="p">)</span>
            <span class="n">detection_thread</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span>
                <span class="n">target</span><span class="o">=</span><span class="n">roi_text_recognition</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="n">gray</span><span class="p">,</span> <span class="n">persistence_dict</span><span class="p">,</span> <span class="n">rois</span><span class="p">))</span>
            <span class="n">detection_thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">persistence_dict</span><span class="p">:</span>
        <span class="n">display_info_dict</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">persistence_dict</span><span class="p">)</span>

    <span class="n">cv2</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">win_name</span><span class="p">,</span> <span class="n">image</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">cv2</span><span class="o">.</span><span class="n">waitKey</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span> <span class="o">==</span> <span class="nb">ord</span><span class="p">(</span><span class="s1">&#39;q&#39;</span><span class="p">):</span>
        <span class="k">break</span>

</pre></div>
    </div>
  </div>
  <div class='clearall'></div>
</div>
</body>
